# Microservice Architecture

## 微服务架构特征

### 初衷

微服务架构越来越来受欢迎，以及越来越多项目在使用应用微服务架构，但遗憾的是没有太多信息可以概述是什么是微服务以及如何实现微服务。

简而言之，微服务架构风格是一种将单体应用拆分为一组微型服务的方法，每个微型服务都在独自的进程中运行，并提供轻量级的通讯机制，通常是HTTP 资源 API。这些微型服务将围绕着业务功能构建，并且可以由全自动部署机制自动部署、可以由不同的编程语言实现，可以使用不同的数据存储技术。

后续内容将以单体应用和微服务之间的比对，来说明微服务的架构特征。

企业级应用通常由三部分组成：

- 客户端用户界面（由运行在用户浏览器上HTML页面和JavaScript脚本）
- 数据库
- 服务端应用程序
  - 处理HTTP请求
  - 执行业务逻辑
  - 从数据库中检索和更新数据
  - 生成要返给浏览器的HTML页面

如果服务端应用程序是单体应用的话，任何有关系统的改动，都会导致构建和发布新版本的服务端应用程序。

随着越来越多的应用上云之后，这些缺陷越来越使用人们无法忍受了，随后催生出微服务架构风格：将应用构建为一组服务。服务可以单独部署且是可扩展的；每一个服务都提供牢固的模块边界，甚至允许用不同的编程语言来编写服务。这些服务也可以由不同的团队来管理。

![](C:\study\technology-share\week02\Microservice Architecture\images\sketch.png)





### 服务组件化

组件定义：组件是可以独立升级和替换的软件单元。

组件化的主要手段：将软件分解为服务。

- library：链接到程序并使用内存中的函数调用进行调用的组件
- service：与诸如Web服务请求或远程过程调用之类的机制进行通信的进程外组件。

组件化带来的问题：

- 进程内通讯变为进程间通讯，远程调用比进程内调用成本要更高，且远程调用的API，更粗犷。
- 接口变动会带来跨服务的影响。



### 围绕业务能力进行组织

大型应用程序，团队组织划分，比如分为服务端逻辑团队、UI团队、数据库团队。那么即是简单的改动，都有可能需要跨团队进行协作，带来许多不必要的开销。

![](.\images\conways-law.png)

微服务则是围绕着业务能力来组织服务。以业务去划分团队，每个团队的都是跨职能的。

![](.\images\PreferFunctionalStaffOrganization.png)



### 产品而非项目

若开发工作使用的是项目模型，那么目的是交付某些软件，交付完后，便会解散该软件的项目团队。

微服务提倡使用产品模型，团队应该在软件的整个生命周期内拥有产品的想法，开发团队对生产中的软件负全部责任。



### Smart endpoints and dumb pipes

微服务社区提倡使用简单的RESTish协议进行接口编排，而不是使用WS-Choreography或BPEL等复杂协议或由中心工具编排的（例子：企业服务总线 EBS ）。

微服务常用的两种协议

- HTTP request-response形式的带资源的API
- 轻量级的消息传递：通过轻量级的消息总线进行消息传递
  - 简单实现：各种MQ中间件，比如RabbitMQ、ZeroMQ、RocketMQ



### 分散治理

指的是技术上的治理。

集中式治理倾向于单一技术平台上实现标准化。

微服务则是分散治理，允许使用各类技术去构建服务。

分散治理的最高目标就是“DevOps”，团队负责他们构建的软件的所有方面。



### 分散数据管理

![](.\images\decentralised-data.png)

提到了DDD设计。

微服务更倾向于让每个服务都管理着自己的数据库。

微服务体系结构[强调服务之间的无事务协调](http://www.eaipatterns.com/ramblings/18_starbucks.html)，并明确认识到一致性可能只是最终的一致性，而问题只能通过补偿操作来解决。



### 基础设施自动化

![](.\images\basic-pipeline.png)

![](.\images\micro-deployment.png)

- 持续交付（CI/CD）
  - 自动化测试
  - 自动化部署



### 容错设计

单体应用微服务化后，会带来额外的复杂性，也会导致许多额外的服务故障，微服务架构需要容忍服务故障，需要去思考如何更加优雅地去响应这种错误请求。

服务随时都有可能故障，所以要有实时故障检测工具/系统/平台，或者是用于应用程序实时监控、预警的工具/系统/平台，以及服务要有弹性恢复的能力，即在可能的情况下，自动恢复服务。



### 进化型设计（Evolutionary Design）

强调模块化设计，着重微服务组件的关键属性：

- 独立可替代性
- 可升级性



## 微服务是未来吗？

- 越来越多公司开始往微服务架构演进。
- 微服务要求组件的边界要明确，跨服务通讯的组件难以重构，涉及到接口的改动，需要双方进行协助，也需要考虑到向后兼容，会使得测试变的更加困难。
- 需要团队有较强的技术能力。

